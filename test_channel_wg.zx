# Test channel with proper synchronization

print("=== Channel WaitGroup Test ===\n")

channel<integer>[10] number_channel
channel<string>[10] message_channel

let wg = wait_group()
wg_add(wg, 2)  # 2 goroutines

async action producer() {
    print("Producer: Starting")
    let i = 1
    while i <= 3 {
        send(number_channel, i * 10)
        print("Producer sent: " + string(i * 10))
        i = i + 1
    }
    close_channel(number_channel)
    send(message_channel, "Producer done")
    close_channel(message_channel)
    print("Producer: Done")
    wg_done(wg)
}

async action consumer() {
    sleep(0.2)
    print("Consumer: Starting")
    let total = 0
    while true {
        let num = receive(number_channel)
        if num == null {
            break
        }
        total = total + num
        print("Consumer received: " + string(num))
    }
    print("Consumer total: " + string(total))
    let msg = receive(message_channel)
    print("Final message: " + string(msg))
    print("Consumer: Done")
    wg_done(wg)
}

async producer()
async consumer()

print("Main: Waiting for completion...")
wg_wait(wg, 10.0)  # Wait up to 10 seconds
print("Main: Complete")

print("\n=== Test Complete ===")
