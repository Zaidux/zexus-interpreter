// Zexus Enhanced VERIFY Keyword Test Suite
// Tests all new verification modes and features

print "=== VERIFY Enhanced Features Test Suite ===";
print "";

// ===== TEST 1: Basic Assertion (Original) =====
print "Test 1: Basic assertion";
try {
    verify true, "Should pass";
    print "✓ Basic assertion passed";
} catch (e) {
    print "✗ Basic assertion failed: " + e;
}

try {
    verify false, "Expected to fail";
    print "✗ Should not reach here";
} catch (e) {
    print "✓ Correctly caught failure: " + e;
}

print "";

// ===== TEST 2: Data Verification - Email =====
print "Test 2: Data verification - email format";
let email1 = "user@example.com";
let email2 = "invalid-email";

try {
    verify is_email(email1), "Invalid email format";
    print "✓ Valid email accepted: " + email1;
} catch (e) {
    print "✗ Email verification failed: " + e;
}

try {
    verify is_email(email2), "Invalid email format";
    print "✗ Should reject invalid email";
} catch (e) {
    print "✓ Correctly rejected invalid email: " + email2;
}

print "";

// ===== TEST 3: Data Verification - URL =====
print "Test 3: Data verification - URL format";
let url1 = "https://example.com/path";
let url2 = "not-a-url";

try {
    verify is_url(url1), "Invalid URL";
    print "✓ Valid URL accepted: " + url1;
} catch (e) {
    print "✗ URL verification failed: " + e;
}

try {
    verify is_url(url2), "Invalid URL";
    print "✗ Should reject invalid URL";
} catch (e) {
    print "✓ Correctly rejected invalid URL";
}

print "";

// ===== TEST 4: Pattern Matching =====
print "Test 4: Pattern matching verification";
let zipcode = "12345";
let zipPattern = "^[0-9]{5}$";

try {
    verify matches_pattern(zipcode, zipPattern), "Invalid zipcode format";
    print "✓ Zipcode pattern matched: " + zipcode;
} catch (e) {
    print "✗ Pattern matching failed: " + e;
}

print "";

// ===== TEST 5: Custom Logic Block =====
print "Test 5: Verification with custom logic block";
let adminUser = false;

action logUnauthorizedAccess() {
    print "  [SECURITY] Unauthorized access attempt detected";
    return "logged";
}

try {
    verify adminUser == true {
        logUnauthorizedAccess();
        print "  [SECURITY] Access blocked";
    }
    print "✗ Should not grant access";
} catch (e) {
    print "✓ Access correctly denied";
}

print "";

// ===== TEST 6: Environment Variable Verification =====
print "Test 6: Environment variable verification";

// Set a test environment variable
env_set("TEST_MODE", "enabled");

try {
    verify env_exists("TEST_MODE"), "TEST_MODE not configured";
    print "✓ Environment variable exists";
} catch (e) {
    print "✗ Env verification failed: " + e;
}

try {
    verify env_exists("NONEXISTENT_VAR"), "Variable not found";
    print "✗ Should fail for nonexistent variable";
} catch (e) {
    print "✓ Correctly detected missing env var";
}

print "";

// ===== TEST 7: Password Strength Validation =====
print "Test 7: Password strength validation";
let weakPass = "123";
let strongPass = "MyP@ssw0rd123!";

action checkPasswordStrength(password) {
    let strength = password_strength(password);
    return strength;
}

try {
    let strength1 = checkPasswordStrength(weakPass);
    verify strength1 != "weak", "Password too weak";
    print "✗ Should reject weak password";
} catch (e) {
    print "✓ Weak password rejected: " + weakPass;
}

try {
    let strength2 = checkPasswordStrength(strongPass);
    verify strength2 == "strong", "Password not strong enough";
    print "✓ Strong password accepted";
} catch (e) {
    print "✗ Strong password check failed";
}

print "";

// ===== TEST 8: Length Validation =====
print "Test 8: String length validation";
let username = "john_doe";

try {
    verify validate_length(username, 3, 20), "Username length invalid";
    print "✓ Username length valid: " + username;
} catch (e) {
    print "✗ Length validation failed: " + e;
}

print "";

// ===== TEST 9: Numeric Validation =====
print "Test 9: Numeric validation";
let age = "25";
let notNumber = "abc";

try {
    verify is_numeric(age), "Age must be numeric";
    print "✓ Numeric value validated: " + age;
} catch (e) {
    print "✗ Numeric check failed";
}

try {
    verify is_numeric(notNumber), "Must be a number";
    print "✗ Should reject non-numeric";
} catch (e) {
    print "✓ Non-numeric correctly rejected";
}

print "";

// ===== TEST 10: Alphanumeric Validation =====
print "Test 10: Alphanumeric validation";
let validCode = "ABC123";
let invalidCode = "ABC-123";

try {
    verify is_alphanumeric(validCode), "Code must be alphanumeric";
    print "✓ Alphanumeric code accepted: " + validCode;
} catch (e) {
    print "✗ Alphanumeric check failed";
}

try {
    verify is_alphanumeric(invalidCode), "Code must be alphanumeric";
    print "✗ Should reject non-alphanumeric";
} catch (e) {
    print "✓ Non-alphanumeric correctly rejected";
}

print "";

// ===== TEST 11: Input Sanitization =====
print "Test 11: Input sanitization";
let dangerousInput = "<script>alert('xss')</script>Hello";
let sanitized = sanitize_input(dangerousInput);

print "Original: " + dangerousInput;
print "Sanitized: " + sanitized;
print "✓ Input sanitization working";

print "";

// ===== TEST 12: Combined Verification =====
print "Test 12: Combined verification checks";

action validateUserRegistration(email, password, username) {
    verify is_email(email), "Invalid email format";
    verify password_strength(password) != "weak", "Password too weak";
    verify validate_length(username, 3, 20), "Username length invalid";
    verify is_alphanumeric(username), "Username must be alphanumeric";
    return true;
}

try {
    let result = validateUserRegistration("user@test.com", "StrongP@ss123", "john123");
    print "✓ User registration validation passed";
} catch (e) {
    print "✗ Registration validation failed: " + e;
}

try {
    let result2 = validateUserRegistration("invalid-email", "weak", "j");
    print "✗ Should fail validation";
} catch (e) {
    print "✓ Invalid registration correctly rejected";
}

print "";

// ===== TEST 13: Phone Number Validation =====
print "Test 13: Phone number validation";
let phone1 = "123-456-7890";
let phone2 = "abc";

try {
    verify is_phone(phone1), "Invalid phone number";
    print "✓ Phone number validated: " + phone1;
} catch (e) {
    print "✗ Phone validation failed";
}

try {
    verify is_phone(phone2), "Invalid phone number";
    print "✗ Should reject invalid phone";
} catch (e) {
    print "✓ Invalid phone rejected";
}

print "";

// ===== TEST 14: Multi-condition Verification =====
print "Test 14: Multi-condition verification";

action validateTransaction(amount, balance, limit) {
    verify amount > 0, "Amount must be positive";
    verify balance >= amount, "Insufficient balance";
    verify amount <= limit, "Amount exceeds limit";
    return "Transaction valid";
}

try {
    let result = validateTransaction(100, 500, 1000);
    print "✓ Transaction validation passed";
} catch (e) {
    print "✗ Transaction validation failed: " + e;
}

try {
    let result2 = validateTransaction(-10, 500, 1000);
    print "✗ Should reject negative amount";
} catch (e) {
    print "✓ Negative amount rejected: " + e;
}

print "";

// ===== TEST 15: Access Control with Blocking =====
print "Test 15: Access control verification";

let userRole = "guest";

action checkAdminAccess() {
    try {
        verify userRole == "admin" {
            print "  [BLOCKED] Guest user attempted admin access";
        }
        return "access_granted";
    } catch (e) {
        return "access_denied";
    }
}

let accessResult = checkAdminAccess();
print "Access result: " + accessResult;
print "✓ Access control working correctly";

print "";

print "=== All Enhanced VERIFY Tests Complete ===";
