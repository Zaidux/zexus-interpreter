# Test: Contract-to-Contract References
# This tests storing contract instances in contract state

contract Storage {
    state data = {};
    
    action set(key, value) {
        data[key] = value;
        return true;
    }
    
    action get(key) {
        return data[key];
    }
}

contract Controller {
    state storage_ref = null;
    state initialized = false;
    
    action init(storage) {
        print("ğŸ”§ Controller.init() called");
        print("   Storage type: " + type(storage));
        
        storage_ref = storage;
        initialized = true;
        
        print("   âœ… Storage reference saved");
        return true;
    }
    
    action store_data(key, value) {
        print("ğŸ“¦ Controller.store_data() called");
        
        if (!initialized) {
            print("   âŒ Controller not initialized");
            return false;
        }
        
        print("   Storage ref type: " + type(storage_ref));
        
        # Call the storage contract's set action
        let result = storage_ref.set(key, value);
        print("   âœ… Data stored via reference");
        return result;
    }
    
    action retrieve_data(key) {
        print("ğŸ“¤ Controller.retrieve_data() called");
        
        if (!initialized) {
            print("   âŒ Controller not initialized");
            return null;
        }
        
        # Call the storage contract's get action through the reference
        let result = storage_ref.get(key);
        print("   âœ… Data retrieved via reference: " + string(result));
        return result;
    }
}

# Create contract instances
print("Creating Storage instance...");
let storage = Storage();

print("\nCreating Controller instance...");
let controller = Controller();

# Initialize controller with storage reference
print("\nInitializing controller with storage reference...");
controller.init(storage);

print("\n=== Testing Attribute Access on ContractReference ===");
print("Storage address via reference: " + string(controller.storage_ref.address));
print("Storage name via reference: " + string(controller.storage_ref.name));

# Store data through controller
print("\nStoring data through controller...");
controller.store_data("test_key", "test_value");

# Retrieve data through controller
print("\nRetrieving data through controller...");
let retrieved = controller.retrieve_data("test_key");

print("\nâœ… Test completed!");
print("Retrieved value: " + string(retrieved));
