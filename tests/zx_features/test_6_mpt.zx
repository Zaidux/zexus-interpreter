// ============================================================================
//  FEATURE 6: Merkle Patricia Trie
// ============================================================================
print("=" * 60)
print("  FEATURE 6: Merkle Patricia Trie")
print("=" * 60)

let stats = {"total": 0, "passed": 0, "failed": 0}
action assert_test(name, condition) {
    stats["total"] = stats["total"] + 1
    if condition {
        stats["passed"] = stats["passed"] + 1
        print("  [PASS] " + string(name))
    } else {
        stats["failed"] = stats["failed"] + 1
        print("  [FAIL] " + string(name))
    }
}

contract MerkleTrie {
    data store = {}
    data node_count = 0
    data root_hash = ""

    action put(key, value) {
        store[key] = value
        node_count = node_count + 1
        root_hash = "root_v" + string(node_count)
        return true
    }

    action lookup(key) {
        return store[key]
    }

    action remove(key) {
        if store[key] != null {
            store[key] = null
            node_count = node_count + 1
            root_hash = "root_v" + string(node_count)
            return true
        }
        return false
    }

    action has(key) {
        return store[key] != null
    }

    action get_version() {
        return node_count
    }

    action get_root() {
        return root_hash
    }

    action get_proof(key) {
        if store[key] == null { return null }
        return {
            "key": key,
            "value": store[key],
            "root": root_hash,
            "proof_hash": "proof_" + string(key) + "_" + string(store[key])
        }
    }

    action take_snap() {
        return {"root": root_hash, "nodes": node_count}
    }
}

// --- 6.1 Put/Get ---
print("")
print("--- 6.1 Basic Put/Get ---")
let trie = MerkleTrie()
trie.put("0xabc1", "account_data_1")
trie.put("0xabc2", "account_data_2")
trie.put("0xdef1", "contract_code")
assert_test("Get value", trie.lookup("0xabc1") == "account_data_1")
assert_test("Contains check", trie.has("0xdef1") == true)
assert_test("Missing key is null", trie.lookup("0x9999") == null)

// --- 6.2 Root Hash ---
print("")
print("--- 6.2 Root Hash Changes ---")
let v_before = trie.get_version()
assert_test("Root hash exists", trie.get_root() != "")
trie.put("0xfff0", "new_data")
let v_after = trie.get_version()
assert_test("Trie version changed after insert", v_before != v_after)

// --- 6.3 Delete ---
print("")
print("--- 6.3 Delete ---")
trie.remove("0xfff0")
assert_test("Deleted key gone", trie.has("0xfff0") == false)

// --- 6.4 Proofs ---
print("")
print("--- 6.4 Merkle Proof ---")
let proof = trie.get_proof("0xabc1")
assert_test("Proof has key", proof["key"] == "0xabc1")
assert_test("Proof has value", proof["value"] == "account_data_1")
assert_test("Proof has root", proof["root"] != "")
assert_test("Proof hash computed", proof["proof_hash"] != "")

let no_proof = trie.get_proof("0xmissing")
assert_test("No proof for missing key", no_proof == null)

// --- 6.5 Snapshot ---
print("")
print("--- 6.5 State Snapshot ---")
let snap = trie.take_snap()
assert_test("Snapshot has root", snap["root"] != "")
assert_test("Snapshot has node count", snap["nodes"] > 0)

// --- Report ---
print("")
print("=" * 60)
print("  MPT Tests: " + string(stats["passed"]) + "/" + string(stats["total"]) + " passed")
if stats["failed"] == 0 { print("  *** ALL PASSED ***") }
print("=" * 60)
