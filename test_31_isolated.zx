# Test 3.1 from ultimate_test
print("3.1: Channel communication...")
channel<integer> number_channel
channel<string> message_channel

action producer() {
    let i = 1
    while i <= 5 {
        send(number_channel, i * 10)
        sleep(0.01)  # Small delay
        i = i + 1
    }
    close_channel(number_channel)
    send(message_channel, "Producer done")
    close_channel(message_channel)
}

action consumer() {
    let total = 0
    while true {
        let num = receive(number_channel)
        if num == null {
            break
        }
        total = total + num
        print("Consumer received: " + string(num))
    }
    print("Consumer total: " + string(total))
    let msg = receive(message_channel)
    print("Final message: " + string(msg))
}

# Run concurrently
try {
    async producer()
    async consumer()
    sleep(0.5)  # Wait for completion
} catch (error) {
    print("Concurrency error: " + string(error))
}
print("")
