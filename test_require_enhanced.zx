// Zexus Enhanced REQUIRE Keyword Test Suite
// Testing prerequisites, dependencies, tolerance logic, and resource requirements

print "=== REQUIRE Enhanced Features Test Suite ===";
print "";

// ===== TEST 1: Basic Requirement (Original) =====
print "Test 1: Basic requirement";
let balance = 1000;
let amount = 500;

try {
    require balance >= amount, "Insufficient balance";
    print "✓ Basic requirement passed";
} catch (e) {
    print "✗ Failed: " + e;
}

print "";

// ===== TEST 2: Blockchain Transaction with Tolerance =====
print "Test 2: Blockchain transaction with conditional tolerance";

let userBalance = 0.08;  // Below minimum
let minRequired = 0.1;
let userIsVIP = true;
let userTotalSpent = 150;

action sendBNB(balance, minimum, isVIP, totalSpent) {
    try {
        require balance >= minimum {
            // Tolerance logic - check if user qualifies for waiver
            if (isVIP && totalSpent >= 100) {
                print "  [TOLERANCE] VIP user with $" + totalSpent + " spent";
                print "  [TOLERANCE] Waiving 0.1 BNB fee for this transaction";
                return true;  // Allow it
            } else {
                print "  [TOLERANCE] User does not qualify for fee waiver";
                return false;  // Reject it
            }
        }
        
        print "✓ Transaction approved";
        return true;
        
    } catch (e) {
        print "✗ Transaction rejected: " + e;
        return false;
    }
}

sendBNB(userBalance, minRequired, userIsVIP, userTotalSpent);

print "";

// ===== TEST 3: Regular User (No Tolerance) =====
print "Test 3: Regular user without VIP status";

let regularUserBalance = 0.08;
let regularUserIsVIP = false;
let regularUserSpent = 50;

sendBNB(regularUserBalance, minRequired, regularUserIsVIP, regularUserSpent);

print "";

// ===== TEST 4: Sufficient Balance (No Need for Tolerance) =====
print "Test 4: User with sufficient balance";

let richUserBalance = 1.5;

try {
    require richUserBalance >= minRequired {
        print "  [TOLERANCE] This shouldn't execute - balance sufficient";
        return true;
    }
    print "✓ Transaction approved - sufficient balance";
} catch (e) {
    print "✗ Failed: " + e;
}

print "";

// ===== TEST 5: Payment Processing with Loyalty Discount =====
print "Test 5: Payment with loyalty points discount";

let paymentAmount = 75;  // Below minimum of 100
let userLoyaltyPoints = 600;
let userSubscribed = false;

action processPayment(amount, loyaltyPoints, subscribed) {
    try {
        require amount >= 100 {
            // Conditional tolerance based on loyalty or subscription
            if (loyaltyPoints >= 500) {
                print "  [LOYALTY] Customer has " + loyaltyPoints + " points";
                print "  [LOYALTY] Applying loyalty discount - minimum waived";
                return true;
            } elif (subscribed) {
                print "  [SUBSCRIBER] Active subscriber - minimum waived";
                return true;
            } else {
                print "  [MINIMUM] Minimum transaction is $100";
                return false;
            }
        }
        
        print "✓ Payment processed";
        return true;
        
    } catch (e) {
        print "✗ Payment failed: " + e;
        return false;
    }
}

processPayment(paymentAmount, userLoyaltyPoints, userSubscribed);

print "";

// ===== TEST 6: Subscriber Gets Discount =====
print "Test 6: Subscriber with small payment";

let smallPayment = 50;
let noLoyaltyPoints = 0;
let isSubscriber = true;

processPayment(smallPayment, noLoyaltyPoints, isSubscriber);

print "";

// ===== TEST 7: No Qualification for Discount =====
print "Test 7: Customer without loyalty or subscription";

processPayment(smallPayment, noLoyaltyPoints, false);

print "";

// ===== TEST 8: Resource Requirements =====
print "Test 8: Resource requirements with tolerance";

let gasAvailable = 18000;
let gasNeeded = 20000;
let isContractOwner = true;

action executeContract(available, needed, owner) {
    try {
        require available >= needed {
            // Owner gets priority gas allocation
            if (owner) {
                print "  [GAS] Contract owner detected";
                print "  [GAS] Allocating priority gas for this transaction";
                return true;
            } else {
                print "  [GAS] Insufficient gas: " + available + " / " + needed;
                return false;
            }
        }
        
        print "✓ Contract executed";
        return true;
        
    } catch (e) {
        print "✗ Contract execution failed: " + e;
        return false;
    }
}

executeContract(gasAvailable, gasNeeded, isContractOwner);

print "";

// ===== TEST 9: API Rate Limiting with Grace Period =====
print "Test 9: API rate limit with grace period for premium users";

let requestCount = 105;  // Exceeded limit of 100
let isPremiumUser = true;
let gracePeriodActive = true;

action checkRateLimit(requests, premium, gracePeriod) {
    try {
        require requests <= 100 {
            // Grace period for premium users
            if (premium && gracePeriod) {
                print "  [API] Premium user in grace period";
                print "  [API] Allowing " + requests + " requests (limit: 100)";
                return true;
            } else if (premium) {
                print "  [API] Premium user - higher limit of 200";
                if (requests <= 200) {
                    return true;
                }
                return false;
            } else {
                print "  [API] Rate limit exceeded: " + requests + " / 100";
                return false;
            }
        }
        
        print "✓ Request allowed";
        return true;
        
    } catch (e) {
        print "✗ Request blocked: " + e;
        return false;
    }
}

checkRateLimit(requestCount, isPremiumUser, gracePeriodActive);

print "";

// ===== TEST 10: Premium Without Grace Period =====
print "Test 10: Premium user with normal higher limit";

let manyRequests = 150;
checkRateLimit(manyRequests, true, false);

print "";

// ===== TEST 11: Regular User Exceeding Limit =====
print "Test 11: Regular user exceeding rate limit";

checkRateLimit(requestCount, false, false);

print "";

// ===== TEST 12: Authentication Requirement =====
print "Test 12: Authentication requirement with fallback";

let userAuthenticated = false;
let hasValidAPIKey = true;
let apiKey = "valid-key-12345";

action accessResource(authenticated, hasKey, key) {
    try {
        require authenticated {
            // Fallback: Check for valid API key
            if (hasKey && key != "") {
                print "  [AUTH] Not authenticated, but valid API key provided";
                print "  [AUTH] Allowing access via API key";
                return true;
            } else {
                print "  [AUTH] Authentication required";
                return false;
            }
        }
        
        print "✓ Access granted";
        return true;
        
    } catch (e) {
        print "✗ Access denied: " + e;
        return false;
    }
}

accessResource(userAuthenticated, hasValidAPIKey, apiKey);

print "";

// ===== TEST 13: Multi-Tier Requirements =====
print "Test 13: Multi-tier transaction requirements";

action processTierTransaction(amount, tier, history) {
    print "Processing " + tier + " tier transaction: $" + amount;
    
    try {
        require amount >= 1000 {
            // Bronze: $100 minimum
            if (tier == "bronze" && amount >= 100) {
                print "  [TIER] Bronze tier - $100 minimum met";
                return true;
            }
            // Silver: $250 minimum
            elif (tier == "silver" && amount >= 250) {
                print "  [TIER] Silver tier - $250 minimum met";
                return true;
            }
            // Gold: $500 minimum
            elif (tier == "gold" && amount >= 500) {
                print "  [TIER] Gold tier - $500 minimum met";
                return true;
            }
            // Platinum: No minimum (or based on history)
            elif (tier == "platinum") {
                print "  [TIER] Platinum tier - no minimum required";
                return true;
            }
            else {
                print "  [TIER] Minimum not met for " + tier + " tier";
                return false;
            }
        }
        
        print "✓ Transaction approved";
        return true;
        
    } catch (e) {
        print "✗ Transaction failed: " + e;
        return false;
    }
}

processTierTransaction(300, "silver", 50);
print "";
processTierTransaction(150, "bronze", 10);
print "";
processTierTransaction(50, "platinum", 100);

print "";

// ===== TEST 14: Emergency Override =====
print "Test 14: Emergency override for critical operations";

let systemInMaintenanceMode = true;
let isEmergencyRequest = true;
let requestor = "admin";

action performOperation(maintenance, emergency, user) {
    try {
        require maintenance == false {
            // Emergency override
            if (emergency && user == "admin") {
                print "  [EMERGENCY] Admin emergency override activated";
                print "  [EMERGENCY] Bypassing maintenance mode";
                return true;
            } else {
                print "  [MAINTENANCE] System in maintenance mode";
                return false;
            }
        }
        
        print "✓ Operation completed";
        return true;
        
    } catch (e) {
        print "✗ Operation blocked: " + e;
        return false;
    }
}

performOperation(systemInMaintenanceMode, isEmergencyRequest, requestor);

print "";

// ===== TEST 15: Combined Requirements Example =====
print "Test 15: Real-world combined requirements";

action finalizeTransaction(amount, balance, authenticated, verified, tier) {
    print "Finalizing transaction...";
    
    // Requirement 1: Authentication
    try {
        require authenticated, "User must be authenticated";
        print "  ✓ Authentication check passed";
    } catch (e) {
        print "  ✗ " + e;
        return false;
    }
    
    // Requirement 2: Email verification (with grace for VIP)
    try {
        require verified {
            if (tier == "vip" || tier == "platinum") {
                print "  ✓ VIP/Platinum user - verification waived";
                return true;
            } else {
                print "  ✗ Email verification required";
                return false;
            }
        }
        print "  ✓ Verification check passed";
    } catch (e) {
        print "  ✗ " + e;
        return false;
    }
    
    // Requirement 3: Sufficient balance (with tier-based minimums)
    try {
        require balance >= amount {
            if (tier == "platinum" && balance >= amount * 0.8) {
                print "  ✓ Platinum user - 80% balance acceptable";
                return true;
            } else {
                print "  ✗ Insufficient balance";
                return false;
            }
        }
        print "  ✓ Balance check passed";
    } catch (e) {
        print "  ✗ " + e;
        return false;
    }
    
    print "✓ Transaction finalized successfully!";
    return true;
}

finalizeTransaction(100, 90, true, false, "platinum");

print "";
print "=== All Enhanced REQUIRE Tests Complete ===";
