// Simplified Part 3.1 test
print "Testing channel communication"

channel<integer>[10] number_channel
channel<string>[10] message_channel

async action producer() {
    let i = 1
    while i <= 5 {
        send(number_channel, i * 10)
        print "Producer sent: " + string(i * 10)
        sleep(0.01)
        i = i + 1
    }
    print "Producer: Closing number_channel"
    close_channel(number_channel)
    print "Producer: Sending final message"
    send(message_channel, "Producer done")
    print "Producer: Closing message_channel"
    close_channel(message_channel)
    print "Producer: Finished"
}

async action consumer() {
    sleep(0.1)
    let total = 0
    print "Consumer: Starting to receive"
    while true {
        let num = receive(number_channel)
        print "Consumer: Received " + string(num)
        if num == null {
            print "Consumer: Got null, breaking"
            break
        }
        total = total + num
        print "Consumer received: " + string(num)
    }
    print "Consumer: After while loop"
    print "Consumer total: " + string(total)
    print "Consumer: About to receive from message_channel"
    let msg = receive(message_channel)
    print "Consumer: Received message: " + string(msg)
    print "Final message: " + string(msg)
    print "Consumer: Finished"
}

async producer()
async consumer()
print "Main: Waiting..."

sleep(15.0)
print "Main: Done waiting"
