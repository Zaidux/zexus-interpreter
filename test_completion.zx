# Test with explicit thread completion tracking
print("=== Thread Completion Test ===\n")

channel<integer>[10] number_channel
channel<string>[10] message_channel

let producer_done = false
let consumer_done = false

async action producer() {
    print("Producer: Start")
    let i = 1
    while i <= 5 {
        send(number_channel, i * 10)
        i = i + 1
    }
    close_channel(number_channel)
    print("Producer: Closed number_channel")
    send(message_channel, "Producer done")
    close_channel(message_channel)
    print("Producer: Complete")
    producer_done = true
}

async action consumer() {
    sleep(0.1)
    print("Consumer: Start")
    let total = 0
    let count = 0
    while true {
        count = count + 1
        print("Consumer: Loop iteration " + string(count))
        let num = receive(number_channel)
        print("Consumer: Received value (iteration " + string(count) + "): " + string(num))
        if num == null {
            print("Consumer: Breaking from loop")
            break
        }
        total = total + num
        print("Consumer received: " + string(num) + ", total now: " + string(total))
    }
    print("Consumer: AFTER LOOP - Line 1")
    print("Consumer: AFTER LOOP - Line 2")
    print("Consumer: About to print total: " + string(total))
    print("Consumer total: " + string(total))
    print("Consumer: About to receive message from message_channel")
    let msg = receive(message_channel)
    print("Consumer: Received message: " + string(msg))
    print("Final message: " + string(msg))
    print("Consumer: Setting consumer_done=true")
    consumer_done = true
    print("Consumer: Complete")
}

async producer()
async consumer()

print("Main: Sleeping...")
sleep(5.0)
print("Main: Done sleeping")
print("Producer done: " + string(producer_done))
print("Consumer done: " + string(consumer_done))
