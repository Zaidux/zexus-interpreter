# Test 3.1 with debug
print("3.1: Channel communication...")
channel<integer> number_channel
channel<string> message_channel

action producer() {
    print("[PRODUCER] Starting...")
    let i = 1
    while i <= 5 {
        print("[PRODUCER] Sending " + string(i * 10))
        send(number_channel, i * 10)
        sleep(0.01)
        i = i + 1
    }
    print("[PRODUCER] Closing channels...")
    close_channel(number_channel)
    send(message_channel, "Producer done")
    close_channel(message_channel)
    print("[PRODUCER] Complete")
}

action consumer() {
    print("[CONSUMER] Starting...")
    let total = 0
    while true {
        print("[CONSUMER] Waiting for value...")
        let num = receive(number_channel)
        print("[CONSUMER] Received: " + string(num))
        if num == null {
            print("[CONSUMER] Got null, breaking")
            break
        }
        total = total + num
        print("Consumer received: " + string(num))
    }
    print("Consumer total: " + string(total))
    let msg = receive(message_channel)
    print("Final message: " + string(msg))
    print("[CONSUMER] Complete")
}

# Run concurrently
print("Calling async producer()...")
async producer()
print("Calling async consumer()...")
async consumer()
print("Sleeping for 0.5 seconds...")
sleep(0.5)
print("Done!")
